{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://backlog-agents/backlog.config.schema.json",
  "title": "Backlog Agents Configuration",
  "description": "Schema for backlog.config.json files used by backlog-agents skills.",
  "type": "object",
  "required": ["version", "project", "backlog", "qualityGates", "codeRules", "ticketValidation"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "description": "Configuration schema version.",
      "enum": ["1.0", "1.1"]
    },
    "project": {
      "type": "object",
      "description": "Project-level metadata.",
      "required": ["name", "stack"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable project name.",
          "minLength": 1
        },
        "stack": {
          "type": "string",
          "description": "Primary technology stack (e.g. typescript, python, generic).",
          "minLength": 1
        },
        "testRunner": {
          "type": "string",
          "description": "Test runner used by the project (e.g. vitest, jest, pytest)."
        },
        "linter": {
          "type": "string",
          "description": "Linter used by the project (e.g. eslint, ruff)."
        },
        "typeChecker": {
          "type": "string",
          "description": "Type checker used by the project (e.g. tsc, mypy)."
        }
      }
    },
    "backlog": {
      "type": "object",
      "description": "Backlog data and template configuration.",
      "required": ["dataDir", "templatesDir", "ticketPrefixes", "requiredSections"],
      "additionalProperties": false,
      "properties": {
        "dataDir": {
          "type": "string",
          "description": "Directory where ticket data files are stored.",
          "minLength": 1
        },
        "templatesDir": {
          "type": "string",
          "description": "Directory where ticket templates are stored.",
          "minLength": 1
        },
        "ticketPrefixes": {
          "type": "array",
          "description": "Allowed ticket-type prefixes.",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "requiredSections": {
          "type": "array",
          "description": "Sections that every ticket must include.",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        }
      }
    },
    "qualityGates": {
      "type": "object",
      "description": "Commands executed as quality gates during ticket implementation.",
      "required": ["testCommand"],
      "additionalProperties": false,
      "properties": {
        "lintCommand": {
          "type": "string",
          "description": "Command to run the linter."
        },
        "typeCheckCommand": {
          "type": "string",
          "description": "Command to run the type checker."
        },
        "testCommand": {
          "type": "string",
          "description": "Command to run the test suite.",
          "minLength": 1
        },
        "buildCommand": {
          "type": "string",
          "description": "Command to build the project."
        },
        "healthCheckCommand": {
          "type": "string",
          "description": "Command to verify project health after changes."
        }
      }
    },
    "codeRules": {
      "type": "object",
      "description": "Code-quality rules enforced during implementation.",
      "additionalProperties": false,
      "properties": {
        "source": {
          "type": "string",
          "description": "Path to a Markdown file containing code rules."
        },
        "hardGates": {
          "type": "array",
          "description": "Rules that must pass; failure blocks ticket completion.",
          "items": {
            "type": "string"
          }
        },
        "softGates": {
          "type": "array",
          "description": "Rules that are checked but do not block ticket completion.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ticketValidation": {
      "type": "object",
      "description": "Validation rules applied when creating or updating tickets.",
      "required": [
        "requireTestStrategy",
        "requireAffectedFiles",
        "requireDependencyCheck",
        "minAcceptanceCriteria",
        "requireVerificationCommands"
      ],
      "additionalProperties": false,
      "properties": {
        "requireTestStrategy": {
          "type": "boolean",
          "description": "Whether tickets must include a test strategy section."
        },
        "requireAffectedFiles": {
          "type": "boolean",
          "description": "Whether tickets must list affected files."
        },
        "requireDependencyCheck": {
          "type": "boolean",
          "description": "Whether tickets must include a dependency check."
        },
        "minAcceptanceCriteria": {
          "type": "integer",
          "description": "Minimum number of acceptance criteria required per ticket.",
          "minimum": 1
        },
        "requireVerificationCommands": {
          "type": "boolean",
          "description": "Whether tickets must include verification commands."
        }
      }
    },
    "agentRouting": {
      "type": "object",
      "description": "Smart agent routing configuration. Determines which agent handles a ticket based on pattern matching.",
      "properties": {
        "rules": {
          "type": "array",
          "description": "Ordered list of routing rules. First matching rule wins.",
          "items": {
            "type": "object",
            "required": ["pattern", "agent", "label"],
            "properties": {
              "pattern": {
                "type": "string",
                "description": "Glob or regex pattern matched against ticket prefix or tags."
              },
              "agent": {
                "type": "string",
                "description": "Agent identifier to route the ticket to (e.g. 'implementer', 'investigator')."
              },
              "label": {
                "type": "string",
                "description": "Human-readable label describing this routing rule."
              }
            }
          }
        },
        "overrides": {
          "type": "object",
          "description": "Per-agent overrides keyed by agent identifier.",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "investigator": {
                "type": "boolean",
                "description": "Whether to run an investigation phase before implementation."
              },
              "reviewers": {
                "type": "number",
                "description": "Number of review passes for this agent."
              }
            }
          }
        },
        "llmOverride": {
          "type": "boolean",
          "description": "Allow the LLM to override routing rules based on ticket content analysis.",
          "default": true
        }
      }
    },
    "reviewPipeline": {
      "type": "object",
      "description": "Configurable review pipeline. Defines which reviewers run and their thresholds.",
      "properties": {
        "reviewers": {
          "type": "array",
          "description": "Ordered list of reviewers that evaluate implementation output.",
          "items": {
            "type": "object",
            "required": ["name", "agent", "focus"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Unique name for this reviewer (e.g. 'code-quality', 'security')."
              },
              "agent": {
                "type": "string",
                "description": "Agent identifier that performs this review."
              },
              "focus": {
                "type": "string",
                "description": "Description of what this reviewer evaluates."
              },
              "required": {
                "type": "boolean",
                "description": "Whether this reviewer must pass for the ticket to be accepted.",
                "default": true
              }
            }
          }
        },
        "confidenceThreshold": {
          "type": "number",
          "description": "Minimum confidence score (0-100) required to accept a review.",
          "minimum": 0,
          "maximum": 100,
          "default": 80
        },
        "maxReviewRounds": {
          "type": "number",
          "description": "Maximum number of review-fix cycles before escalation.",
          "default": 3
        }
      }
    },
    "llmOps": {
      "type": "object",
      "description": "Cloud routing, caching, budgets, and batch policy for cost-optimized LLM usage.",
      "additionalProperties": false,
      "properties": {
        "registry": {
          "type": "object",
          "description": "Model registry configuration.",
          "additionalProperties": false,
          "properties": {
            "source": {
              "type": "string",
              "description": "Path to model-registry.json.",
              "default": ".backlog-ops/model-registry.json"
            },
            "refreshCommand": {
              "type": "string",
              "description": "Command to refresh the model registry.",
              "default": "bash scripts/ops/sync-model-registry.sh"
            },
            "strictMode": {
              "type": "boolean",
              "description": "When true, skills can only use aliases defined in the registry.",
              "default": true
            }
          }
        },
        "gateway": {
          "type": "object",
          "description": "LiteLLM gateway connection settings.",
          "additionalProperties": false,
          "properties": {
            "baseURL": {
              "type": "string",
              "description": "LiteLLM proxy base URL.",
              "default": "http://localhost:4000"
            },
            "apiKeyEnv": {
              "type": "string",
              "description": "Environment variable name for the LiteLLM master key.",
              "default": "LITELLM_MASTER_KEY"
            },
            "requireEscalationReason": {
              "type": "boolean",
              "description": "Require documented reason when escalating to frontier models.",
              "default": true
            }
          }
        },
        "routing": {
          "type": "object",
          "description": "Model alias routing by workflow phase. Uses aliases from model registry.",
          "additionalProperties": false,
          "properties": {
            "entryModelClassify": {
              "type": "string",
              "description": "Model alias for ticket classification/triage.",
              "default": "cheap"
            },
            "entryModelDraft": {
              "type": "string",
              "description": "Model alias for draft generation (tickets, plans).",
              "default": "cheap"
            },
            "entryModelImplement": {
              "type": "string",
              "description": "Model alias for code implementation.",
              "default": "balanced"
            },
            "entryModelReview": {
              "type": "string",
              "description": "Model alias for code review passes.",
              "default": "cheap"
            },
            "escalationModel": {
              "type": "string",
              "description": "Model alias for frontier escalation.",
              "default": "frontier"
            },
            "maxEscalationsPerTicket": {
              "type": "integer",
              "description": "Maximum frontier escalations allowed per ticket.",
              "minimum": 0,
              "default": 1
            }
          }
        },
        "tokenPolicy": {
          "type": "object",
          "description": "Token budget limits by workflow phase.",
          "additionalProperties": false,
          "properties": {
            "maxInputByPhase": {
              "type": "object",
              "description": "Max input tokens per phase. Keys: classify, draft, implement, review, refine.",
              "additionalProperties": { "type": "integer", "minimum": 0 },
              "default": {
                "classify": 4000,
                "draft": 8000,
                "implement": 32000,
                "review": 16000,
                "refine": 12000
              }
            },
            "maxOutputByPhase": {
              "type": "object",
              "description": "Max output tokens per phase. Keys: classify, draft, implement, review, refine.",
              "additionalProperties": { "type": "integer", "minimum": 0 },
              "default": {
                "classify": 1000,
                "draft": 4000,
                "implement": 16000,
                "review": 4000,
                "refine": 8000
              }
            },
            "contextWindowStrategy": {
              "type": "string",
              "description": "Strategy for managing context window limits.",
              "enum": ["truncate-oldest", "summarize", "rag-augment"],
              "default": "summarize"
            }
          }
        },
        "cachePolicy": {
          "type": "object",
          "description": "Multi-layer caching configuration per ADR-004.",
          "additionalProperties": false,
          "properties": {
            "providerPromptCaching": {
              "type": "boolean",
              "description": "Enable Anthropic prompt caching (cache_control breakpoints).",
              "default": true
            },
            "stablePrefixMinTokens": {
              "type": "integer",
              "description": "Minimum tokens in stable prefix to qualify for prompt caching (Anthropic requires 1024+).",
              "minimum": 1024,
              "default": 2048
            },
            "responseCache": {
              "type": "object",
              "description": "LiteLLM response cache settings.",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": true },
                "ttlSeconds": { "type": "integer", "minimum": 0, "default": 3600 },
                "backend": {
                  "type": "string",
                  "enum": ["redis", "s3", "local"],
                  "default": "redis"
                }
              }
            },
            "semanticCache": {
              "type": "object",
              "description": "Vector-similarity cache for near-duplicate prompts.",
              "additionalProperties": false,
              "properties": {
                "enabled": { "type": "boolean", "default": false },
                "backend": {
                  "type": "string",
                  "enum": ["qdrant", "redis-vss", "chromadb"],
                  "default": "qdrant"
                },
                "threshold": {
                  "type": "number",
                  "description": "Minimum cosine similarity to count as cache hit.",
                  "minimum": 0,
                  "maximum": 1,
                  "default": 0.88
                }
              }
            }
          }
        },
        "batchPolicy": {
          "type": "object",
          "description": "Anthropic/OpenAI Batch API policy for non-interactive workloads.",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable batch offloading for eligible phases.",
              "default": true
            },
            "eligiblePhases": {
              "type": "array",
              "description": "Workflow phases eligible for batch execution.",
              "items": { "type": "string" },
              "default": ["refinement", "bulk-ticket-validation", "cost-report", "duplicate-detection"]
            },
            "forceBatchWhenQueueOver": {
              "type": "integer",
              "description": "Force batch mode when queue has more items than this threshold.",
              "minimum": 1,
              "default": 25
            },
            "maxConcurrentBatchJobs": {
              "type": "integer",
              "description": "Maximum concurrent batch jobs to submit.",
              "minimum": 1,
              "default": 10
            },
            "retryPolicy": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "maxRetries": { "type": "integer", "minimum": 0, "default": 3 },
                "backoffMultiplier": { "type": "number", "minimum": 1, "default": 2.0 }
              }
            }
          }
        },
        "ragPolicy": {
          "type": "object",
          "description": "RAG (Retrieval-Augmented Generation) configuration for codebase context.",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable RAG-based context retrieval for ticket generation and implementation.",
              "default": false
            },
            "embeddingModel": {
              "type": "string",
              "description": "Model used for embedding generation.",
              "default": "text-embedding-3-small"
            },
            "vectorStore": {
              "type": "string",
              "description": "Vector store backend for embeddings.",
              "enum": ["qdrant", "chromadb", "local-faiss"],
              "default": "local-faiss"
            },
            "indexPath": {
              "type": "string",
              "description": "Path to the local vector index.",
              "default": ".backlog-ops/rag-index"
            },
            "chunkSize": {
              "type": "integer",
              "description": "Token chunk size for document splitting.",
              "minimum": 128,
              "default": 512
            },
            "topK": {
              "type": "integer",
              "description": "Number of top chunks to retrieve per query.",
              "minimum": 1,
              "default": 10
            },
            "reindexCommand": {
              "type": "string",
              "description": "Command to rebuild the RAG index.",
              "default": "python scripts/ops/rag_index.py --rebuild"
            }
          }
        }
      }
    },
    "sentinel": {
      "type": "object",
      "description": "Sentinel code-review skill configuration.",
      "additionalProperties": false,
      "properties": {
        "enabled": { "type": "boolean", "default": true },
        "installGitHook": { "type": "boolean", "default": true },
        "prescan": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "runLinter":        { "type": "boolean", "default": true },
            "runTests":         { "type": "boolean", "default": true },
            "runTypeCheck":     { "type": "boolean", "default": true },
            "detectHardcoded":  { "type": "boolean", "default": true },
            "detectTodos":      { "type": "boolean", "default": true },
            "maxFunctionLines": { "type": "integer", "default": 80 }
          }
        },
        "reviewers": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "security": { "type": "boolean", "default": true },
            "quality":  { "type": "boolean", "default": true }
          }
        },
        "ragDeduplication": { "type": "boolean", "default": true },
        "patternThresholds": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "recurring":          { "type": "integer", "default": 2 },
            "escalateToSoftGate": { "type": "integer", "default": 3 },
            "escalateToHardGate": { "type": "integer", "default": 5 }
          }
        },
        "ticketMapping": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "default": {
            "security": "SEC",
            "bug": "BUG",
            "techDebt": "TASK",
            "architecture": "TASK"
          }
        }
      }
    }
  }
}
